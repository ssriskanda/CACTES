---
title: "CACTES COVID Analysis"
output:
  pdf_document: default
  word_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(knitr)   # contains kable() function
#setwd("~/Documents/CACTES")
#loading data
data <- read_csv("Combined Cleaned Data.csv")
```


**Descriptive statistics – ethnicity**
```{r}
#switch letter option with the name of ethnicity
data$Q1[data$Q1 == "A"] <- "Bunyankole"
data$Q1[data$Q1 == "B"] <- "Muganda"
data$Q1[data$Q1 == "C"] <- "Mukiga"
data$Q1[data$Q1 == "D"] <- "Musoga"
data$Q1[data$Q1 == "E"] <- "Muhaya"
data$Q1[data$Q1 == "F"] <- "Other"

#code to print bar graph
ggplot(data, aes(x = Q1)) + geom_bar(fill="steelblue") + labs(x = "Ethnicity", y = "Count")

```


**Descriptive statistics – What are the 3 most common ethnicities? ** 
```{r}
#count unique data points for Question 1
Q1_table <- data %>%
  count(Q1, sort = TRUE)
total <- dim(data)[1] #total number of observations
Q1_table$Percentage <- (Q1_table$n/total)*100
Q1_table <- Q1_table %>%
  rename(Ethnicity = Q1,
         Count = n)
print(Q1_table)
```
Top three ethnicities are Muganda(85.27%), Other (10.08%), and Bunyankole (2.325%)


**Descriptive statistics – religion**
```{r}
#switch letter option with the name of religion
data$Q2[data$Q2 == "A"] <- "Catholic"
data$Q2[data$Q2 == "B"] <- "Anglican"
data$Q2[data$Q2 == "C"] <- "Protestant"
data$Q2[data$Q2 == "D"] <- "Muslim"
data$Q2[data$Q2 == "E"] <- "Born Again"
data$Q2[data$Q2 == "F"] <- "No religion"
data$Q2[data$Q2 == "G"] <- "Other"


#code to print bar graph
ggplot(data, aes(x = Q2)) + geom_bar(fill="steelblue") + labs(x = "Religion", y = "Count")
```
NOTE: Some people found themselves to be a mix of the religion --> need to discuss  


**Descriptive statistics – What are the 3 most common religions? **
```{r}
Q2_table <- data %>%
  count(Q2, sort = TRUE)

Q2_table$Percentage <- (Q2_table$n/total)*100
Q2_table <- Q2_table %>%
  rename(Religion = Q2,
         Count = n)
print(Q2_table)
```
Three most common religions are Catholic (45.74%), Muslim (37.2%), and Anglican (6.2%)


**Descriptive statistics – Education**
```{r}
data$Q3[data$Q3 == "A"] <- "Primary"
data$Q3[data$Q3 == "B"] <- "Secondary"
data$Q3[data$Q3 == "C"] <- "Tertiary"
data$Q3[data$Q3 == "D"] <- "Bachelors and Higher"
data$Q3[data$Q3 == "E"] <- "Bachelors and Higher"
data$Q3[data$Q3 == "F"] <- "None"

#factor the options so they go in desired order
data$Q3 <- factor(data$Q3, levels = c("None", "Primary", "Secondary", "Tertiary", "Bachelors and Higher"))


#code to print bar graph
ggplot(data, aes(x = Q3)) + geom_bar(fill="steelblue") + labs(x = "Education", y = "Count")
```


**Descriptive statistics – what is the percent of respondents that held the highest level of education? **
```{r}
Q4_table <- data %>%
  count(Q4)

Q4_table$Percentage <- (Q4_table$n/total)*100
Q4_table <- Q4_table %>%
  rename(Highest.Level = Q4,
         Count = n)
print(Q4_table)
```
30.23% of respondents have the highest level of education in his/her household. 68.99% are not.


**Descriptive statistics – What is the [average/media etc.] household size?**
```{r}
Q6_vector <- data$Q6

#calculate mean
Q6_mean <- mean(Q6_vector, na.rm = TRUE) #remove anyone who didn't answer this question
print(Q6_mean)

#calculate median
Q6_med <- median(Q6_vector, na.rm = TRUE) #remove anyone who didn't answer this question
print(Q6_med)


#create function for mode
mode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}
Q6_mode <- mode(Q6_vector)
print(Q6_mode)
```
Mean = `Q6_mean`
Median = `Q6_med`
Mode = `Q6_mode`


**What is the average percent of household members that generate an income?**
```{r}
names <- c("Q6", "Q10")
Household_data <- data[names]

#create percent of workers in each household
Household_data <- Household_data %>%
  mutate(Percent.of.Workers = (Q10/Q6)*100)

#average percent 
worker_mean <- mean(Household_data$Percent.of.Workers, na.rm = TRUE) #remove any observations that were NA

print(worker_mean)
```
The average percent of household members that generate an income is `worker_mean` 


**Descriptive statistics – number of children in the household under the age of 18**
```{r}
Q7_vector <- data$Q7
#calculate mean
Q7_mean <- mean(Q7_vector, na.rm = TRUE) #remove anyone who didn't answer this question
#calculate median
Q7_med <- median(Q7_vector, na.rm = TRUE) #remove anyone who didn't answer this question
#calculate mode
Q7_mode <- mode(Q7_vector)
```
Mean = `Q7_mean`
Median = `Q7_med`
Mode = `Q7_mode`


**Descriptive statistics – What is the percent of children (<18) in the household that attends school regularly before COVID19**
```{r}
names.2 <- c("Q7", "Q8")
Children_data <- data[names.2]

#create percent of workers in each household
Children_data <- Children_data %>%
  mutate(Percent.of.Children = (Q8/Q7)*100)

#average percent 
children_mean <- mean(Children_data$Percent.of.Children, na.rm = TRUE) #remove any observations that were NA

print(children_mean)
```
Note: There are some inconsistencies in the data that needs to be followed up with CACTES


**Descriptive statistics – What is the (average/median) number of people working in a household? **
```{r}
Q10_vector <- data$Q10
#calculate mean
Q10_mean <- mean(Q10_vector, na.rm = TRUE) #remove anyone who didn't answer this question
#calculate median
Q10_med <- median(Q10_vector, na.rm = TRUE) #remove anyone who didn't answer this question
#calculate mode
Q10_mode <- mode(Q10_vector)
```
Mean = `Q10_mean`
Median = `Q10_med`
Mode = `Q10_mode`


**Descriptive statistics – What sectors does the sample population work in?**
```{r}
sectors <- c("Agriculture", "Transportation", "Education" ,"Sponsership", "Construction", "Business", "Trade", "Government", "Law", "Health", "Food", "Other")

count <- c(sum(data$agriculture),sum(data$transportation), sum(data$education), sum(data$sponsership), sum(data$construction), sum(data$business), sum(data$trade), sum(data$government), sum(data$law), sum(data$health), sum(data$food), sum(data$other))

Work_data <- tbl_df(cbind(sectors, count))
Work_data$count <- as.numeric(Work_data$count)

Work_data <- Work_data %>%
  mutate(Percent.Work = (count/total)*100)
print(Work_data)
```


**Are there any differences in sectors that people work in between the two districts? **
```{r}
#GO BACK AND CHECK IT
```


**What is the average monthly income?**
```{r}
Q12_vector <- data$Q12
#calculate mean
Q12_mean <- mean(Q12_vector, na.rm = TRUE) #remove anyone who didn't answer this question
print(Q12_mean)

#calculate standard deviation
Q12_sd <- sd(Q12_vector, na.rm = TRUE)#remove anyone who didn't answer this question
print(Q12_sd)
```
Mean = `Q12_mean`
Standard Deviation = `Q12_sd`


**What is the daily expenditure before lockdown? **
```{r}
Q13_vector <- data$Q13
#calculate mean
Q13_mean <- mean(Q13_vector, na.rm = TRUE) #remove anyone who didn't answer this question
print(Q13_mean)

#calculate standard deviation
Q13_sd <- sd(Q13_vector, na.rm = TRUE)#remove anyone who didn't answer this question
print(Q13_sd)
```
Mean = `Q13_mean`
Standard Deviation = `Q13_sd`


**What is the daily expenditure after lockdown?**
```{r}
Q14_vector <- data$Q14
#calculate mean
Q14_mean <- mean(Q14_vector, na.rm = TRUE) #remove anyone who didn't answer this question
print(Q14_mean)

#calculate standard deviation
Q14_sd <- sd(Q14_vector, na.rm = TRUE)#remove anyone who didn't answer this question
print(Q14_sd)
```
Mean = `Q14_mean`
Standard Deviation = `Q14_sd`


**How does the level of education of the respondent affect the economic status of a household? **
```{r}
education.lm <- lm(Q13 ~ Q3, data = data)
summary(education.lm)
```


**How does of the level of education of the respondent affect the change in economic status of the household post-COVID19**
```{r}
#I have no idea what is being asked here
```


**What are the top 3 household expenses? **
```{r}
Groups <- c("Food", "PPE", "Medicine" ,"Water", "Electricity", "Fuel/charcoal", "Education", "Healthcare", "Other")

Count <- c(sum(data$Q15.A),sum(data$Q15.B),sum(data$Q15.C),sum(data$Q15.D),sum(data$Q15.E),sum(data$Q15.F),sum(data$Q15.G),sum(data$Q15.H), length(which(!is.na(data$Q15_Other))))

Expense_data <- tbl_df(cbind(Groups, Count))
Expense_data$Count <- as.numeric(Expense_data$Count)
Expense_data <- Expense_data[order(-Count),]

Expense_data <- Expense_data[1:3,]
print(Expense_data)
```
Three highest expenses are food, water, and electricity


**How many households have at least one member that requires medication/medical care on a regular basis? **
```{r}
#fixing minor error seen in the data
data$Q16[125] <- "A"
data$Q16_Optional[125] <- "ARVS"

#Convert letter to option
data$Q16[data$Q16 == "A"] <- "Yes"
data$Q16[data$Q16 == "B"] <- "No"

#code to print bar graph
ggplot(data, aes(x = Q16)) + geom_bar(fill="steelblue") + labs(x = "Does anyone in the home take medication?", y = "Count")

medication_table <- count(data, vars = Q16)
medication_table <-medication_table %>%
  rename(Medication = vars, Count = n) %>%
  mutate(Percent = (Count/total)*100)
print(medication_table)
```


**What is the most common medication used? **
```{r}
unique(data$Q16_Optional)

#need to check with group about this since there are some inconsistencies with the medications listed
```


**What is the frequency of different illnesses in the sample population? **
```{r}
#Broke up Qustion 17 based on the following options 

Q17_Options <-c("Q17.A", "Q17.B","Q17.C", "Q17.D", "Q17.E", "Q17.F", "Q17.G")
for(x in Q17_Options){
  data[x] <- 0
}

for(i in 1:nrow(data)){
  sen <- strsplit(data$Q15[i], ",")
  data[i,"Q17.A"] <- ifelse(grepl("A", sen),1,0)
  data[i,"Q17.B"] <- ifelse(grepl("B", sen),1,0)
  data[i,"Q17.C"] <- ifelse(grepl("C", sen),1,0)
  data[i,"Q17.D"] <- ifelse(grepl("D", sen),1,0)
  data[i,"Q17.E"] <- ifelse(grepl("E", sen),1,0)
  data[i,"Q17.F"] <- ifelse(grepl("F", sen),1,0)
  data[i,"Q17.G"] <- ifelse(grepl("G", sen),1,0)
  data[i,"Q17.H"] <- ifelse(grepl("H", sen),1,0)
}

ill <- c("HIV", "Diabetes","Heart Condition", "Tuberculosis", "Malaria", "Cancer","Other")
count <- c(sum(data$Q17.A), sum(data$Q17.B), sum(data$Q17.C),sum(data$Q17.D),sum(data$Q17.E),sum(data$Q17.F),sum(data$Q17.G),sum(data$Q17.H))

#Note to Sindu: reconcile the differences in options
```


**Does the education level of the respondent affect their knowledge of additional symptoms of COVID19? **
```{r}
data %>% 
  count(Q19, sort=TRUE) # frequency of response values

# Too many NAs
```


**What does the sample population think are the common methods in which COVID19 spreads?**
```{r}
data %>% 
  select(Q20.A:Q20.I) %>% 
  colSums(na.rm=TRUE) * 100 / nrow(data) # percent for each option
```


**What percent of the sample population knows the common methods in which COVID19 spreads?**
```{r}
data %>% 
  filter(Q20.B==1 & Q20.D==1 & Q20.E==1) %>% # sample that selected all of the correct answers ( B, D, E)
  nrow() * 100 / nrow(data) # compute their percent
```


**Does the sample population know important facts about COVID19? **
```{r}
false_cols <- c("Q21.1", "Q21.2", "Q21.4", "Q21.5", "Q21.6", "Q21.10")
data <- data  %>% 
  mutate(across(all_of(false_cols), function(x) {
    ifelse(x=="FALSE", 1, 0)
  }))

true_cols <- c("Q21.3", "Q21.7", "Q21.8", "Q21.9", "Q21.11")
data <- data  %>% 
  mutate(across(all_of(true_cols), function(x) {
    ifelse(x=="TRUE", 1, 0)
  }))

data <- data %>%
  mutate(across(Q22, function(x) {
  ifelse(x=="B", 1, 0)
  }))

data %>% 
  select(Q21.1:Q22, -Q21.4_Notes)  %>% 
  colSums(na.rm=TRUE) * 100 / nrow(data) # percent correct for each option
```


**Does the level of education of the respondent affect the COVID19 knowledge score?**
```{r}

data[, "knowledge_score"] <- data %>% 
  select(Q21.1:Q22, -Q21.4_Notes)  %>% 
  rowSums(na.rm=TRUE)

data %>%
  select(Q3, knowledge_score) %>%
  group_by(Q3) %>%
  summarize(count=n(),
            mean_score=mean(knowledge_score, na.rm = TRUE))

cor(data %>% 
         select(Q3, knowledge_score) %>% 
         mutate_if(is.factor, as.numeric))

library(GGally)
ggcorr(data %>% 
         select(Q3, Q21.1:Q22, -Q21.4_Notes, knowledge_score) %>% 
         mutate_if(is.factor, as.numeric), 
       label=TRUE, 
       label_size=2, 
       label_round=2, 
       label_alpha=TRUE)
```


**Does the sector in which in the household work in affect the respondent’s COVID19 knowledge score?**
```{r}
data %>% count(, sort=TRUE) # too many sectors, need to reduce this manually

data %>% 
  select(Q11_Source1, knowledge_score) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate_if(is.factor, as.numeric)

data %>% 
  select(agriculture:other)  %>% 
  colSums(na.rm=TRUE) * 100 / nrow(data)
```


**How many people think that handwashing can protect against COVID19? **
```{r}
data %>%
  select(Q22) %>%
  group_by(Q22) %>%
  summarize(percent_score=n() * 100 / nrow(data))
```


**Does the sample population believe that COVID19 could be treated during the survey period? **
```{r}
data %>% count(Q23.1) # need to coerce values
```


**Is there a relationship between the depression score and the respondent’s education level, gender, household position, household size, and number of children (<18) in the household?**
```{r}
data <- data %>%
  mutate_at(vars(Q36.1:Q36.9, -contains('Notes')), ~.-1)

data[, 'depression_score'] <- data %>% 
  select(Q36.1:Q36.9, -contains('Notes')) %>% 
  rowSums(na.rm=TRUE)

data %>%
  select(Q3, depression_score) %>%
  group_by(Q3) %>%
  summarize(count=n(),
            mean_score=mean(depression_score, na.rm = TRUE))

data %>%
  select(Position_of_Respondent, depression_score) %>%
  group_by(Position_of_Respondent) %>%
  summarize(count=n(),
            mean_score=mean(depression_score, na.rm = TRUE))

cor(data %>% 
         select(Q3, Q6, depression_score) %>% 
         mutate_if(is.factor, as.numeric))

ggcorr(data %>% 
         select(Q3, Female, Q6, Q7, Q36.1:Q36.9, depression_score, -contains('Notes')) %>% 
         mutate_if(is.factor, as.numeric), 
       label=TRUE, 
       label_size=2, 
       label_round=2, 
       label_alpha=TRUE)
```


**Are there any additional comments with regards to the depression survey? **
```{r}
df <- data %>% 
  select(contains('Notes') & contains('Q36'))
  
df[rowSums(is.na(df)) != ncol(df), ]
```


**Is there a relationship between the depression score and the difficulty for completing daily activities?**
```{r}
data %>%
  select(Q37, depression_score) %>%
  group_by(Q37) %>%
  summarize(count=n(),
            mean_score=mean(depression_score, na.rm = TRUE))
```


**Does knowing someone who has tested positive for COVID19 increase anxiety?**
```{r}
data <- data %>%
  mutate_at(vars(Q38.1:Q38.7, -contains('Notes')), ~.-1)

data[, 'gad_score'] <- data %>%
  select(Q38.1:Q38.7, -contains('Notes'))  %>% 
  rowSums(na.rm=TRUE)

data %>%
  select(Q35, gad_score) %>%
  group_by(Q35) %>%
  summarize(count=n(),
            mean_score=mean(gad_score, na.rm = TRUE))
```


**Is there a relationship between the anxiety score and the respondent’s education level, gender, household position, household size, and number of children (<18) in the household?**
```{r}
cor(data %>% 
         select(Q3, Q6, gad_score) %>% 
         mutate_if(is.factor, as.numeric))

ggcorr(data %>% 
         select(Q3, Female, Q6, Q7, Q38.1:Q38.7, gad_score, -contains('Notes')) %>% 
         mutate_if(is.factor, as.numeric), 
       label=TRUE, 
       label_size=2, 
       label_round=2, 
       label_alpha=TRUE)
```


**Is there a relationship between the anxiety score and the difficulty for completing daily activities? **
```{r}
data %>%
  select(Q39, gad_score) %>%
  group_by(Q39) %>%
  summarize(count=n(),
            mean_score=mean(gad_score, na.rm = TRUE))
```


```{r}
data %>%
  select(Q40_MentalHealthCounselor, gad_score, depression_score)  %>%
  group_by(Q40_MentalHealthCounselor) %>%
  summarize(count=n(), 
            mean_depression_score=mean(depression_score, na.rm = TRUE),
            mean_anxiety_score=mean(gad_score, na.rm = TRUE))

data %>%
  select(Q40_SpiritualHealther, gad_score, depression_score)  %>%
  group_by(Q40_SpiritualHealther) %>%
  summarize(count=n(),
            mean_depression_score=mean(depression_score, na.rm = TRUE),
            mean_anxiety_score=mean(gad_score, na.rm = TRUE))

data %>%
  select(`Q40_Doctor/Nurse`, gad_score, depression_score)  %>%
  group_by(`Q40_Doctor/Nurse`) %>%
  summarize(count=n(),
            mean_depression_score=mean(depression_score, na.rm = TRUE),
            mean_anxiety_score=mean(gad_score, na.rm = TRUE))
```


```{r}
library(tm)
library(wordcloud)
library(wordcloud2)
library(RColorBrewer)

text <- data %>%
          select(Q41_Additional_Comments)
docs <- Corpus(VectorSource(text))
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
docs <- tm_map(docs, content_transformer(tolower))
docs <- tm_map(docs, removeWords, stopwords("english"))
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(42)

wordcloud(words = df$word, freq = df$freq, min.freq = 3,           
          max.words=200, random.order=FALSE, rot.per=0.35,            
          colors=brewer.pal(8, "Dark2"))
```


**Mean Scores**
```{r}
data %>% 
  select(contains('score'), 'gad_score') %>%
  summary()
```




**Correlations on entire data**
```{r}

library(corrplot)
sig=0.5
# convert data to numeric in order to run correlations
# convert to factor first to keep the integrity of the data
# each value will become a number rather than turn into NA
df_cor <- data %>% mutate_if(is.character, as.factor)
df_cor <- df_cor %>% mutate_if(is.factor, as.numeric)

# run a correlation and drop the insignificant ones
corr <- cor(df_cor)
# prepare to drop duplicates and correlations of 1     
corr[lower.tri(corr, diag=TRUE)] <- NA 
# drop perfect correlations
# corr[corr == 1] <- NA 
# turn into a 3-column table
corr <- as.data.frame(as.table(corr))
# remove the NA values from above 
corr <- na.omit(corr) 
# select significant values  
corr <- subset(corr, abs(Freq) > sig) 
# sort by highest correlation
corr <- corr[order(-abs(corr$Freq)),] 
# print table
print(corr)
# turn corr back into matrix in order to plot with corrplot
mtx_corr <- reshape2::acast(corr, Var1~Var2, value.var="Freq")

# plot correlations visually
corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
```

